# 서브쿼리

## 서브쿼리

- 하나의 SQL 문 안에 포함되어 있는 또 다른 SQL 문을 말한다.
- 반드시 괄호로 묶어야한다.
- EX) SELECT 안에 SELECT 문, INSERT, UPDATE, DELETE 안에 SELECT 문

### 서브쿼리 사용 가능한 곳

1. SELECT 절
2. FROM 절
3. WHERE 절
4. HAVING 절
5. ORDER 절
6. 기타 DML(INSERT, UPDATE, DELETE) 절

> GROUP BY 절은 사용 불가❗

## 서브 쿼리 종류

### 1. 동작하는 방식에 따라

1. UN-CORRELATED(비연관) 서브쿼리
    - 서브쿼리가 메인쿼리 컬럼을 가지고 있지 않은 형태의 서브쿼리
    - 메인쿼리에 서브쿼리가 실행된 결과 값을 제공하기 위한 목적으로 사용
2. CORRELATED(연관) 서브쿼리
    - 서브쿼리가 메인쿼리 컬럼을 가지고 있는 형태의 서브쿼리
    - 일반적으로 메인쿼리가 먼저 수행된 후에 서브쿼리에서 조건이 맞는지 확인하고자 할 때 사용

### 2. 위치에 따라

1. 스칼라 서브쿼리
    - SELECT 에 사용하는 서브쿼리
    - 서브쿼리 결과를 마치 `하나의 컬럼`처럼 사용하기 위해 주로 사용한다. => `단일행 서브쿼리` 형태
    - 조인의 대체 연산
    - 스칼라 서브쿼리를 사용한 조인 처리 시 `OUTER JOIN` 이 기본값(값이 없더라도 생략되지 않고 NULL 출력)

   ```oracle
   SELECT *
          (SELECT *
           FROM TEST2
           WHERE TEST2.NAME IS NOT NULL)
   FROM TEST;
   ```

2. 인라인뷰
    - FROM 절에 사용하는 서브쿼리
    - 서브쿼리 결과를 테이블처럼 사용하기 위해 주로 사용
   ```oracle
      SELECT *
   
      FROM (SELECT *
            FROM TEST2
            WHERE TEST2.NAME IS NOT NULL) AS T1
      WHERE T1.NAME IS NOT NULL;
      
      ```
3. WHERE 절 서브 쿼리
    - 가장 일반적인 서브쿼리
    - 비교 상수 자리에 값을 전달하기 위한 목적으로 주로 사용(상수항의 대체)
    - 리턴 데이터의 형태에 단일행 서브쿼리, 다중행 서브쿼리, 다중컬럼 서브쿼리, 상호연관 서브쿼리로 구분
   ```oracle
      SELECT *
      FROM  TEST
      WHERE T1.NAME = (SELECT *
            FROM TEST2
            WHERE TEST2.NAME IS NOT NULL);
      
      ```

- **WHERE 절 서브쿼리 종류**

1. 단일행 서브쿼리
    - 서브쿼리 결과가 1개의 행이 리턴되는 형태
    - 단일행 서브쿼리 연산자 종류

   | 연산자  | 의미     |
      |------|--------|
   | =    | 같다     |
   | <>   | 같지 않다  |
   | (>)  | 크다     |
   | (>=) | 크거나 같다 |
   | <    | 작다     |
   | <=   | 작거나 같다 |

2. 다중행 서브쿼리
    - 서브쿼리 결과가 `여러 행이 리턴`되는 형태
    - '=', '>','<'와 같은 비교 연산자 사용 불가(여러 값이랑 비교할 수 없는 연산자들)
    - 서브 쿼리 결과를 하나로 요약하거나 다중행 서브쿼리 연산자 사용

   | 연산자     | 의미       | 예시                                          |
      |---------|----------|---------------------------------------------|
   | (IN)    | 같은 값을 찾음 |
   | (> ANY) | 최소값을 반환함 | [ > ANY(2000, 3000) ] : 최소값(2000보다 큰 행 반환)  
   | (< ANY) | 최대값을 반환함 | [ < ANY(2000, 3000) ] : 최대값(3000보다 작은 행 반환) 
   | (< ALL) | 최소값을 반환함 | [ < ALL(2000, 3000) ] : 최소값(3000보다 작은 행 반환) 
   | (> ALL) | 최소값을 반환함 | [ > ALL(2000, 3000) ] : 최대값(3000보다 큰 행 반환)  

   ```oracle
   -- 서브쿼리 결과를 하나의 행이 되도록 변경
   SELECT EMPNO, ENAME, SAL
   FROM EMP
   WHERE SAL > (SELECT MIN(SAL) FROM WHERE DEPNO = 10);
   
   -- 다중행 서브쿼리 연산
   SELECT EMPNO, ENAME, SAL
   FROM EMP
   WHERE SAL > ANY (SELECT SAL FROM WHERE DEPNO = 10);
   ```

3. 다중컬럼 서브쿼리
    - 서브쿼리 결과가 여러 컬럼이 리턴되는 형태
    - 메인쿼리와의 비교 컬럼이 2개 이상
    - 대소 비교 전달 불가(두 값을 동시에 묶어 대소 비교 할 수 없다.)
4. 상호연관 서브쿼리
    - 메인쿼리와 서브쿼리의 비교를 수행하는 형태
    - 비교할 집단이나 조건은 서브쿼리에 명시(메인쿼리 절에는 서브쿼리 컬럼이 정의되지 않았기 때문에 에러 발생)
    - 상호연관 서브쿼리 연산 순서
        1. 메인쿼리 테이블
        2. 메인쿼리 WHERE 절
        3. 서브쿼리 테이블
        4. 서브쿼리 WHERE 절
        5. 메인쿼리 값을 서브쿼리 컬럼과 비교하여 조건절 완성
        6. 위 조건에 성립하는 행의 그룹연산 결과 확인
        7. 위 결과를 메인쿼리에 전달하여 해당 조건을 만족하는 행만 추출

## 인라인 뷰(INLINE VIEW)

- 쿼리 안에 뷰 형태로 테이블처럼 조회할 데이터를 정의하기 위해 사용한다.
- 테이블명이 존재하지 않기 대문에 다른 테이블과 조인 시 `반드시 테이블 별칭 명시` -> 단독으로 사용하는 경우 불필요
- WHERE 절 서브쿼리와 다르게 서브쿼리 결과를 메인 쿼리 어느 절에서도 사용할 수 있다.
- 인라인뷰의 결과와 메인쿼리 테이블과 조인할 목적으로 주로 사용한다.
- 모든 연산자 사용 가능하다.
- 주의점❗ : 인라인뷰에서의 함수에 의한 출력결고는 `컬럼 별칭`으로 통해 메인쿼리에 전달

## 서브쿼리 주의사항
1. 특별한 경우(TOP-N 분석 등)을 제외하고는 서브 쿼리절에 `ORDER BY` 절은 사용 불가
2. 단일 행 서브쿼리와 다중 행 서브쿼리에 따라 연산자 선택이 필요하다